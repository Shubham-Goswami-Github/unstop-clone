{% load static %}
{% csrf_token %}

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Register Page</title>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet" />


  <!-- Select2 CSS -->
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<!-- jQuery -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<!-- Select2 JS -->
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    body, html {
      height: 100%;
      font-family: Arial, sans-serif;
      background: #f1f1f1;
    }

    .outer-wrapper {
      width: 90%;
      max-width: 1000px;
      margin: 50px auto;
      background: #fff;
      border-radius: 40px 12px 40px 100px;
      box-shadow: 0 0 30px rgba(0,0,0,0.1);
      overflow: hidden;
      position: relative;
    }

    .login-wrapper {
      display: flex;
      height: 600px;
    }

    .login-left {
      background: #ffe100;
      width: 50%;
      border-radius: 0 100px 0 100px;
      overflow: hidden;
      margin: 20px;
      position: relative;
    }

    .login-left img {
      width: 100%;
      height: 100%;
      object-fit: contain;
      position: absolute;
      opacity: 0;
      transition: opacity 1s ease;
    }

    .login-left img.active {
      opacity: 1;
    }

    .register-right {
      width: 50%;
      padding: 30px 50px;
      overflow-y: auto;
      position: relative;
    }

    .register-right h2 {
      font-size: 26px;
      margin-bottom: 5px;
    }

    .register-right p {
      font-size: 14px;
      color: #666;
      margin-bottom: 30px;
    }

    .option-card {
      padding: 20px;
      border-radius: 12px;
      margin-bottom: 20px;
      cursor: pointer;
      transition: all 0.3s ease;
      min-height: 120px;
      border: 2px solid transparent;
    }

    .option-card:hover {
      transform: scale(1.02);
      border-color: #999;
    }

    .option-card.selected {
      border-color: #1a73e8;
    }

    .option-card i {
      font-size: 28px;
      margin-bottom: 8px;
    }

    .candidate-card {
      background: rgba(255, 152, 0, 0.1);
    }

    .recruiter-card {
      background: rgba(33, 150, 243, 0.1);
    }

    .option-card i.fa-user {
      color: #ff9800;
    }

    .option-card i.fa-magnifying-glass {
      color: #2196f3;
    }

    .option-card strong {
      display: block;
      font-size: 16px;
      margin-bottom: 4px;
    }

    .option-card small {
      font-size: 13px;
      color: #444;
    }

    .bottom-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 30px;
    }

    .login-link {
      font-size: 14px;
    }

    .login-link a {
      color: #1a73e8;
      font-weight: bold;
      text-decoration: none;
    }

    .next-btn {
      background: transparent;
      border: 2px solid #1a73e8;
      color: #1a73e8;
      padding: 10px 20px;
      font-size: 14px;
      font-weight: bold;
      border-radius: 20px;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .next-btn:hover {
      background: #1a73e8;
      color: white;
    }

    .form-group {
      margin-bottom: 15px;
    }

    .form-row {
      display: flex;
      gap: 10px;
    }

    .form-row .form-group {
      flex: 1;
    }

    .form-group input {
      width: 100%;
      padding: 10px;
      border-radius: 6px;
      border: 1px solid #ccc;
    }

    .gender-options {
      display: flex;
      gap: 10px;
      margin-bottom: 15px;
    }

    .gender-box {
      flex: 1;
      border: 1px dotted #aaa;
      border-radius: 8px;
      padding: 10px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .gender-box:hover {
      background-color: #f0f0f0;
    }

    .gender-box i {
      font-size: 20px;
      margin-bottom: 5px;
    }

    .checkbox-group {
      margin-bottom: 10px;
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 13px;
    }

    .password-group {
      position: relative;
    }

    .password-group input {
      padding-right: 40px;
    }

    .password-group i {
      position: absolute;
      top: 50%;
      right: 10px;
      transform: translateY(-50%);
      cursor: pointer;
      color: #888;
    }

    @media(max-width: 768px) {
      .login-wrapper {
        flex-direction: column;
        height: auto;
      }

      .login-left, .register-right {
        width: 100%;
        height: 300px;
      }

      .outer-wrapper {
        border-radius: 20px;
      }

      .register-right {
        padding: 20px;
        height: auto;
      }

      .bottom-bar {
        flex-direction: column;
        gap: 10px;
      }
    }

.gender-box {
  border: 2px solid transparent;
  padding: 10px;
  border-radius: 8px;
  text-align: center;
  cursor: pointer;
  transition: all 0.3s ease;
}

.gender-box.selected {
  border-color: #1976d2;
  background-color: rgba(25, 118, 210, 0.1);
}

.circle-option {
  width: 38px;
  height: 38px;
  border-radius: 50%;
  display: inline-flex;
  justify-content: center;
  align-items: center;
  border: 1px dotted #aaa;
  margin: 5px;
  cursor: pointer;
  transition: all 0.2s ease;
}

.circle-option:hover {
  background-color: #f0f0f0;
}

.circle-option.selected {
  background-color: #1a73e8;
  color: white;
  border-color: #1a73e8;
  font-weight: bold;
}
.circle-option-college {
  display: inline-block;
  padding: 8px 16px;
  margin: 5px;
  border-radius: 30px;
  border: 1px dotted #aaa;
  cursor: pointer;
  font-size: 13px;
  background-color: #fff;
  transition: all 0.3s ease;
}

.circle-option-college:hover {
  background-color: #f5f5f5;
}

.circle-option-college.selected {
  border-color: #1a73e8;
  background-color: #e8f0fe;
  color: #1a73e8;
  font-weight: bold;
}

.user-type-card {
  flex: 1 0 48%;
  min-height: 120px;
  border: 2px solid transparent;
  border-radius: 12px;
  text-align: center;
  padding: 20px;
  cursor: pointer;
  transition: all 0.3s ease;
  font-weight: 500;
}

.user-type-card i {
  font-size: 30px;
  margin-bottom: 10px;
  display: block;
}

.user-type-card:hover {
  transform: scale(1.02);
  border-color: #1a73e8;
}

.user-type-card.selected {
  border-color: #1a73e8;
  background-color: #e8f0fe !important;
  font-weight: bold;
  color: #1a73e8;
}

.career-purpose-card {
  flex: 1 0 48%;
  min-height: 120px;
  border: 1px dotted #aaa;
  border-radius: 12px;
  text-align: center;
  padding: 20px;
  cursor: pointer;
  transition: all 0.3s ease;
  font-weight: 500;
  background-color: rgba(0, 0, 0, 0.02); /* fallback default */
}

.career-purpose-card i {
  font-size: 28px;
  margin-bottom: 10px;
  display: block;
  transition: transform 0.2s ease;
}

.career-purpose-card:hover i {
  transform: scale(1.1);
}

.career-purpose-card:hover {
  border-color: #1a73e8;
}

.career-purpose-card.selected {
  border-color: #1a73e8;
  background-color: #e8f0fe !important;
  font-weight: bold;
  color: #1a73e8;
}

input[list] {
  padding: 8px;
  font-size: 14px;
}

datalist option {
  font-size: 14px;
}


  </style>
</head>
<body>

<div class="outer-wrapper">
  <div class="login-wrapper">
    <!-- Left Section -->
    <div class="login-left">
      <img src="{% static 'images/F1.webp' %}" class="active" />
      <img src="{% static 'images/F2.webp' %}" />
      <img src="{% static 'images/F3.webp' %}" />
      <img src="{% static 'images/F4.webp' %}" />
    </div>

    <!-- Right Section -->
    <div class="register-right" id="registerSection">
      <div id="choiceSection">
        <h2>Create New Account</h2>
        <p>Join Unstop and find your dream job or recruit talented candidates</p>

        <div class="option-card candidate-card" id="candidateCard" onclick="selectCard('candidate')">
          <i class="fa-solid fa-user"></i>
          <strong>Sign Up as Candidate</strong>
          <small>Compete, learn and apply for jobs and internships</small>
        </div>

        <div class="option-card recruiter-card" id="recruiterCard" onclick="selectCard('recruiter')">
          <i class="fa-solid fa-magnifying-glass"></i>
          <strong>Sign Up as Recruiter</strong>
          <small>Host Competitions, Hire Talent, and offer career opportunities</small>
        </div>

        <div class="bottom-bar">
          <div class="login-link">Already have an account? <a href="/login/">Login</a></div>
          <button class="next-btn" onclick="showCandidateForm()">Next</button>
        </div>
      </div>
    </div>
  </div>
</div>
<script>

  let candidateData = {};  // âœ… Global object to hold form data across steps

  const images = document.querySelectorAll('.login-left img');
  let current = 0;
  setInterval(() => {
    images[current].classList.remove('active');
    current = (current + 1) % images.length;
    images[current].classList.add('active');
  }, 4000);

  function selectCard(type) {
    document.getElementById('candidateCard').classList.remove('selected');
    document.getElementById('recruiterCard').classList.remove('selected');
    if (type === 'candidate') {
      document.getElementById('candidateCard').classList.add('selected');
    } else {
      document.getElementById('recruiterCard').classList.add('selected');
    }
  }

  function togglePassword(icon, fieldId) {
    const input = document.getElementById(fieldId);
    if (input.type === "password") {
      input.type = "text";
      icon.classList.remove("fa-eye");
      icon.classList.add("fa-eye-slash");
    } else {
      input.type = "password";
      icon.classList.add("fa-eye");
      icon.classList.remove("fa-eye-slash");
    }
  }

  function selectGender(elem, genderValue) {
    const colorMap = {
      Male: '#1e88e5',
      Female: '#e91e63',
      Other: '#9e9e9e'
    };
    document.querySelectorAll('.gender-box').forEach(el => {
      el.classList.remove('selected');
      el.style.borderColor = 'transparent';
      el.style.backgroundColor = 'transparent';
    });
    elem.classList.add('selected');
    elem.style.borderColor = colorMap[genderValue];
    elem.style.backgroundColor = colorMap[genderValue] + '20';
    document.getElementById('selectedGender').value = genderValue;
  }

  function checkPasswordMatch() {
    const password = document.getElementById('passwordField').value;
    const confirm = document.getElementById('confirmPassword').value;
    const error = document.getElementById('passwordError');

    if (password && confirm && password !== confirm) {
      error.style.display = 'block';
    } else {
      error.style.display = 'none';
    }
  }

  function showCandidateForm() {
    const section = document.getElementById('registerSection');
    section.innerHTML = `
      <form id="candidateForm">
        <h2> Sign Up as Candidate</h2>

        <div class="form-row">
          <div class="form-group">
            <input type="text" id="firstName" name="first_name" placeholder="First Name *" required value="${candidateData.first_name || ''}">
          </div>
          <div class="form-group">
            <input type="text" id="lastName" name="last_name" placeholder="Last Name *" required value="${candidateData.last_name || ''}">
          </div>
        </div>

        <div class="form-group">
          <input type="email" id="email" name="email" placeholder="Email *" required value="${candidateData.email || ''}">
        </div>
        <div class="form-group">
          <input type="number" id="phone" name="phone" placeholder="Phone Number *" required value="${candidateData.phone || ''}">
        </div>

        <div class="gender-options" id="genderOptions">
          <div class="gender-box" onclick="selectGender(this, 'Male')">
            <i class="fa-solid fa-mars" style="color:#1e88e5; font-size: 20px;"></i><div>Male</div>
          </div>
          <div class="gender-box" onclick="selectGender(this, 'Female')">
            <i class="fa-solid fa-venus" style="color:#e91e63; font-size: 20px;"></i><div>Female</div>
          </div>
          <div class="gender-box" onclick="selectGender(this, 'Other')">
            <i class="fa-solid fa-genderless" style="color:#9e9e9e; font-size: 20px;"></i><div>Other</div>
          </div>
        </div>
        <input type="hidden" id="selectedGender" name="gender" required value="${candidateData.gender || ''}">

        <div class="form-row">
          <div class="form-group password-group">
            <input type="password" id="passwordField" name="password" placeholder="Password *" required value="${candidateData.password || ''}">
            <i class="fa-solid fa-eye" onclick="togglePassword(this, 'passwordField')"></i>
          </div>
          <div class="form-group password-group">
            <input type="password" id="confirmPassword" name="confirm_password" placeholder="Confirm Password *" required oninput="checkPasswordMatch()">
            <i class="fa-solid fa-eye" onclick="togglePassword(this, 'confirmPassword')"></i>
            <small id="passwordError" style="color: red; display: none;">Passwords do not match.</small>
          </div>
        </div>

        <div class="checkbox-group">
          <input type="checkbox" id="info" name="agreed_info" ${candidateData.agreed_info ? 'checked' : ''} required>
          <label for="info">All information is correct</label>
        </div>
        <div class="checkbox-group">
          <input type="checkbox" id="loop" name="stay_in_loop" ${candidateData.stay_in_loop ? 'checked' : ''}>
          <label for="loop">Stay in the LOOP</label>
        </div>

        <div class="bottom-bar">
          <div class="login-link">Already have an account? <a href="/login/">Login</a></div>
          <button type="submit" class="next-btn">Next</button>
        </div>
      </form>
    `;

    setTimeout(() => {
      if (candidateData.gender) {
        const genderBoxes = document.querySelectorAll('.gender-box');
        genderBoxes.forEach(box => {
          if (box.textContent.trim() === candidateData.gender) {
            selectGender(box, candidateData.gender);
          }
        });
      }
    }, 100);

    document.getElementById('candidateForm').addEventListener('submit', function (e) {
      e.preventDefault();

      const password = document.getElementById('passwordField')?.value || '';
      const confirmPassword = document.getElementById('confirmPassword')?.value || '';

      if (password !== confirmPassword) {
        document.getElementById('passwordError').style.display = 'block';
        return;
      }

      candidateData.first_name = document.getElementById('firstName')?.value || '';
      candidateData.last_name = document.getElementById('lastName')?.value || '';
      candidateData.email = document.getElementById('email')?.value || '';
      candidateData.phone = document.getElementById('phone')?.value || '';
      candidateData.gender = document.getElementById('selectedGender')?.value || '';
      candidateData.password = password;
      candidateData.agreed_info = document.getElementById('info')?.checked || false;
      candidateData.stay_in_loop = document.getElementById('loop')?.checked || false;

      if (!candidateData.gender) {
        alert('Please select your gender!');
        return;
      }

      showUserTypeStep();
    });
  }




function showUserTypeStep() {
  const section = document.getElementById('registerSection');
  section.innerHTML = `
    <h2><i class="fa-solid fa-arrow-left" onclick="showCandidateForm()" style="cursor:pointer; margin-right:10px;"></i> Ready to Be Unstoppable</h2>
    <p>Let's add some basic information</p>

    <label style="font-weight: bold;">User Type *</label>
    <div class="form-row" style="flex-wrap: wrap; gap: 14px;">
      <div class="user-type-card" onclick="selectUserType(this, 'school')" style="background-color: #fff8e1;">
        <i class="fa-solid fa-school" style="color: #ff9800;"></i>
        <div>School</div>
      </div>
      <div class="user-type-card" onclick="selectUserType(this, 'college')" style="background-color: #e8eaf6;">
        <i class="fa-solid fa-graduation-cap" style="color: #3f51b5;"></i>
        <div>College Student</div>
      </div>
      <div class="user-type-card" onclick="selectUserType(this, 'fresher')" style="background-color: #e0f2f1;">
        <i class="fa-solid fa-user-clock" style="color: #009688;"></i>
        <div>Fresher</div>
      </div>
      <div class="user-type-card" onclick="selectUserType(this, 'professional')" style="background-color: #efebe9;">
        <i class="fa-solid fa-briefcase" style="color: #795548;"></i>
        <div>Professional</div>
      </div>
    </div>

    <div class="login-link" style="margin-top: 20px;">Already have an account? <a href="/login/">Login</a></div>

    <div id="userDetailsFields"></div>

    <div class="bottom-bar" style="margin-top: 30px;">
      <button class="next-btn" onclick="showCandidateForm()">
        <i class="fa-solid fa-arrow-left"></i> Back
      </button>
      <button class="next-btn" onclick="storeUserTypeFieldsAndNext()">Next</button>

    </div>
  `;

  // âœ… Re-select previously selected user type (if any)
  if (candidateData.user_type) {
    const cards = document.querySelectorAll('.user-type-card');
    cards.forEach(card => {
      if (card.textContent.trim().toLowerCase() === candidateData.user_type) {
        selectUserType(card, candidateData.user_type); // triggers form render
      }
    });
  }
}
function selectUserType(el, type) {
  document.querySelectorAll('.user-type-card').forEach(card => card.classList.remove('selected'));
  el.classList.add('selected');

  candidateData.user_type = type;  // ðŸ”¥ Save user type here

  if (type === 'school') {
    showSchoolFields();
  } else if (type === 'college' || type === 'fresher') {
    showCollegeFields();
  } else if (type === 'professional') {
    showProfessionalFields();
  }
}
function storeUserTypeFieldsAndNext() {
  const selectedTypeCard = document.querySelector('.user-type-card.selected');
  if (!selectedTypeCard) {
    alert("Please select a user type!");
    return;
  }

  const type = candidateData.user_type;

  // === School Validation ===
  if (type === 'school') {
    const schoolName = document.getElementById('schoolName')?.value;
    const schoolCity = document.getElementById('schoolCity')?.value;
    const currentClass = document.querySelector('.circle-option.selected')?.getAttribute('data-class');

    if (!schoolName || !schoolCity || !currentClass) {
      alert("Please fill all required school fields!");
      return;
    }

    candidateData.school_name = schoolName;
    candidateData.current_class = parseInt(currentClass);
    candidateData.school_city = schoolCity;

  }

  // === College / Fresher Validation ===
  if (type === 'college' || type === 'fresher') {
    const collegeName = document.getElementById('collegeName')?.value;
    const courseName = document.getElementById('courseName')?.value;
    const startYear = document.getElementById('startYear')?.value;
    const endYear = document.getElementById('endYear')?.value;
    const collegeCity = document.getElementById('collegeCity')?.value;
    const domain = document.querySelector('.circle-option-college.selected')?.getAttribute('data-domain');

    if (!collegeName || !courseName || !startYear || !endYear || !collegeCity || !domain) {
      alert("Please fill all required college/fresher fields!");
      return;
    }

    candidateData.college_name = collegeName;
    candidateData.course_name = courseName;
    candidateData.start_year = startYear;
    candidateData.end_year = endYear;
    candidateData.college_city = collegeCity;
    candidateData.domain = domain;
  }

  // === Professional Validation ===
  if (type === 'professional') {
    const experience = document.getElementById('experienceYears')?.value;
    const jobRole = document.getElementById('jobRole')?.value;
    const company = document.getElementById('company')?.value;
    const startYear = document.getElementById('jobStartYear')?.value;
    const endYear = document.getElementById('jobEndYear')?.value;
    const jobCity = document.getElementById('jobCity')?.value;

    if (!experience || !jobRole || !company || !startYear || !endYear || !jobCity) {
      alert("Please fill all required professional fields!");
      return;
    }

    candidateData.experience_years = experience;
    candidateData.current_job_role = jobRole;
    candidateData.current_company = company;
    candidateData.job_start_year = startYear;
    candidateData.job_end_year = endYear;
    candidateData.job_city = jobCity;
  }

  console.log("âœ… USER TYPE STEP FINAL DATA BEFORE CAREER:", candidateData);
  showCareerPurposeStep();
}

function showSchoolFields() {
  if (!dropdownData || !dropdownData.schools) {
    console.warn("Dropdown data not loaded yet.");
    return;
  }

  const schoolName = candidateData.school_name || '';
  const currentClass = candidateData.current_class || '';
  const schoolCity = candidateData.school_city || '';

  const schoolOptions = dropdownData.schools.map(s => {
    const selected = s.name === schoolName ? 'selected' : '';
    return `<option value="${s.name}" data-id="${s.id}" data-city="${s.city}" ${selected}>${s.name}</option>`;
  }).join('');

  document.getElementById('userDetailsFields').innerHTML = `
    <div class="form-group mb-3">
      <label for="schoolName" style="font-weight: 500; margin-bottom: 6px;">School Name <span style="color: red;">*</span></label>
      <select id="schoolName" name="school_name" class="form-control" required onchange="handleSchoolChange()" style="padding: 10px; border: 1px solid #ccc; border-radius: 6px; font-size: 14px;">
        <option value="">Select School</option>
        ${schoolOptions}
      </select>
    </div>

    <div class="form-group mb-3">
      <label style="font-weight: 500; margin-bottom: 6px;">Current Class <span style="color: red;">*</span></label>
      <div style="display: flex; flex-wrap: wrap; gap: 8px;">
        ${[...Array(12).keys()].map(i => {
          const cls = i + 1;
          const selected = currentClass == cls ? 'selected' : '';
          return `<div class="circle-option ${selected}" onclick="selectCircleOption(this)" data-class="${cls}">${cls}</div>`;
        }).join('')}
      </div>
    </div>

    <div class="form-group mb-2">
      <label for="schoolCity" style="font-weight: 500; margin-bottom: 6px;">School City <span style="color: red;">*</span></label>
      <input type="text" id="schoolCity" name="school_city" class="form-control" placeholder="School City" value="${schoolCity}" style="padding: 10px; border: 1px solid #ccc; border-radius: 6px; font-size: 14px;">
    </div>
  `;

  // Manually call change if already selected
  setTimeout(() => {
    if (schoolName) handleSchoolChange();
  }, 0);
}


function handleSchoolChange() {
  const select = document.getElementById('schoolName');
  const selectedOption = select.options[select.selectedIndex];

  const schoolId = selectedOption.getAttribute('data-id');
  const city = selectedOption.getAttribute('data-city');

  // âœ… Set in candidateData
  candidateData.school_id = schoolId ? parseInt(schoolId) : null;
  document.getElementById('schoolCity').value = city || '';
}

function showCollegeFields() {
  if (!dropdownData || !dropdownData.domains) {
    console.warn("Dropdown data not yet loaded.");
    return;
  }

  const domain = candidateData.domain || '';
  const courseName = candidateData.course_name || '';
  const startYear = candidateData.start_year || '';
  const endYear = candidateData.end_year || '';
  const collegeName = candidateData.college_name || '';
  const collegeCity = candidateData.college_city || '';

  const domainOptions = dropdownData.domains.map(d => {
    const selected = d === domain ? 'selected' : '';
    return `<div class="circle-option-college ${selected}" onclick="selectCollegeOption(this)" data-domain="${d}">${d}</div>`;
  }).join('');

  const courseOptions = dropdownData.courses.map(c => {
    const selected = c === courseName ? 'selected' : '';
    return `<option value="${c}" ${selected}>${c}</option>`;
  }).join('');

  const collegeOptions = dropdownData.colleges.map(c => {
    const selected = c.name === collegeName ? 'selected' : '';
    const safeCourses = c.courses_accepted ? c.courses_accepted.replace(/"/g, '&quot;') : '[]';
    return `
      <option 
        value="${c.name}" 
        data-id="${c.id}" 
        data-city="${c.city || ''}" 
        data-courses="${safeCourses}"
        ${selected}
      >${c.name}</option>`;
  }).join('');

  // Generate years
  const currentYear = new Date().getFullYear();
  const yearOptions = (selectedVal) => {
    return Array.from({ length: (currentYear + 5 - 2010 + 1) }, (_, i) => {
      const year = 2010 + i;
      const selected = selectedVal == year ? 'selected' : '';
      return `<option value="${year}" ${selected}>${year}</option>`;
    }).join('');
  };

  document.getElementById('userDetailsFields').innerHTML = `

    <!-- College Name Dropdown -->
    <div class="form-group mb-3">
      <label for="collegeName" style="font-weight: 500; margin-bottom: 6px;">College Name <span style="color: red;">*</span></label>
      <select id="collegeName" name="college_name" class="form-control" required onchange="handleCollegeChange()" style="padding: 10px; border-radius: 6px;">
        <option value="">Select College</option>
        ${collegeOptions}
      </select>
    </div>

    <!-- Course Name Dropdown -->
    <div class="form-group mb-3">
      <label for="courseName" style="font-weight: 500; margin-bottom: 6px;">Course Name <span style="color: red;">*</span></label>
      <select id="courseName" name="course_name" class="form-control" required style="padding: 10px; border-radius: 6px;">
        <option value="">Select Course</option>
        ${courseOptions}
      </select>
    </div>

    <!-- Start and End Year -->
    <div class="form-row mb-3" style="display: flex; gap: 10px;">
      <div class="form-group" style="flex: 1;">
        <label for="startYear" style="font-weight: 500; margin-bottom: 6px;">Start Year <span style="color: red;">*</span></label>
        <select id="startYear" name="start_year" class="form-control" required style="padding: 10px; border-radius: 6px;" onchange="validateYearRange()">
          <option value="">Select Start Year</option>
          ${yearOptions(startYear)}
        </select>
      </div>
      <div class="form-group" style="flex: 1;">
        <label for="endYear" style="font-weight: 500; margin-bottom: 6px;">End Year <span style="color: red;">*</span></label>
        <select id="endYear" name="end_year" class="form-control" required style="padding: 10px; border-radius: 6px;" onchange="validateYearRange()">
          <option value="">Select End Year</option>
          ${yearOptions(endYear)}
        </select>
      </div>
    </div>

    <!-- College City -->
    <div class="form-group mb-3">
      <label for="collegeCity" style="font-weight: 500; margin-bottom: 6px;">College City <span style="color: red;">*</span></label>
      <input type="text" id="collegeCity" name="college_city" value="${collegeCity}" class="form-control" placeholder="College City" required>
    </div>

    <!-- Domain Circles -->
    <div class="form-group mb-2">
      <label style="font-weight: 500; margin-bottom: 6px;">Domain <span style="color: red;">*</span></label>
      <div id="domainOptions" style="display: flex; flex-wrap: wrap; gap: 8px;">
        ${domainOptions}
      </div>
    </div>
  `;

  setTimeout(() => {
    if (collegeName) handleCollegeChange();
    if (domain) updateCourseDropdown();
  }, 0);
}

// Year validation
function validateYearRange() {
  const start = parseInt(document.getElementById("startYear").value);
  const end = parseInt(document.getElementById("endYear").value);

  if (!isNaN(start) && !isNaN(end) && start > end) {
    alert("Start Year cannot be greater than End Year.");
    document.getElementById("startYear").value = "";
    document.getElementById("endYear").value = "";
  }
}

function handleCollegeChange() {
  const select = document.getElementById('collegeName');
  const selectedOption = select.options[select.selectedIndex];

  const city = selectedOption.getAttribute('data-city') || '';
  const id = selectedOption.getAttribute('data-id') || null;
  const coursesJSON = selectedOption.getAttribute('data-courses') || '[]';

  document.getElementById('collegeCity').value = city;

  candidateData.college_id = id;
  candidateData.college_city = city;

  let courseList = [];
  try {
    courseList = JSON.parse(coursesJSON);
  } catch (err) {
    console.warn("Invalid courses JSON:", coursesJSON);
  }

  updateCourseDropdown(courseList);
}




function updateCourseDropdown(courseList = []) {
  const courseSelect = document.getElementById('courseName');
  const selected = candidateData.course_name || '';

  courseSelect.innerHTML = `<option value="">Select Course</option>` +
    courseList.map(course => `
      <option value="${course}" ${course === selected ? 'selected' : ''}>${course}</option>
    `).join('');
}


function showFresherFields() {
  showCollegeFields();
}

function selectCircleOption(el) {
  el.parentElement.querySelectorAll('.circle-option').forEach(e => e.classList.remove('selected'));
  el.classList.add('selected');

  candidateData.current_class = parseInt(el.getAttribute('data-class'));  // âœ… save class
}


function selectCollegeOption(el) {
  document.querySelectorAll('.circle-option-college').forEach(opt => opt.classList.remove('selected'));
  el.classList.add('selected');

  candidateData.domain = el.getAttribute('data-domain');  // âœ… save domain
}


function showProfessionalFields() {
  if (!dropdownData || !dropdownData.companies) {
    console.warn("Dropdown data not loaded yet.");
    return;
  }

  const experienceYears = candidateData.experience_years || '';
  const jobRole = candidateData.current_job_role || '';
  const company = candidateData.current_company || '';
  const jobStartYear = candidateData.job_start_year || '';
  const jobEndYear = candidateData.job_end_year || '';
  const jobCity = candidateData.job_city || '';

  const currentYear = new Date().getFullYear();

  const experienceOptions = Array.from({ length: 21 }, (_, i) => {
    const selected = experienceYears == i ? 'selected' : '';
    return `<option value="${i}" ${selected}>${i} year${i === 1 ? '' : 's'}</option>`;
  }).join('');

  const yearOptions = (selectedVal) => {
    return Array.from({ length: (currentYear + 5 - 2010 + 1) }, (_, i) => {
      const year = 2010 + i;
      const selected = selectedVal == year ? 'selected' : '';
      return `<option value="${year}" ${selected}>${year}</option>`;
    }).join('');
  };

  const companyOptions = dropdownData.companies.map(c => {
    const name = typeof c === 'string' ? c : c.name;
    const city = typeof c === 'string' ? '' : c.city || '';
    const id = typeof c === 'string' ? '' : c.id || '';
    const selected = name === company ? 'selected' : '';
    return `<option value="${name}" data-city="${city}" data-id="${id}" ${selected}>${name}</option>`;
  }).join('');

  document.getElementById('userDetailsFields').innerHTML = `
    <div class="form-group">
      <label for="experienceYears" style="margin-bottom: 6px; font-weight: 500;">Experience (in years) <span style="color: red;">*</span></label>
      <select id="experienceYears" name="experience_years" class="form-control">
        <option value="">Select Experience</option>
        ${experienceOptions}
      </select>
    </div>

    <div class="form-group">
      <input type="text" id="jobRole" name="current_job_role" placeholder="Current Job Role *" value="${jobRole}">
    </div>

    <div class="form-group">
      <label for="company" style="margin-bottom: 8px; display: block; font-weight: 600;">Current Company *</label>
      <select id="company" name="current_company" style="width: 100%; padding: 8px 12px; border: 1px solid #ccc; border-radius: 6px;" onchange="handleCompanyChange()">
        <option value="">Select Company</option>
        ${companyOptions}
      </select>
    </div>

    <div class="form-row">
      <div class="form-group" style="margin-right: 10px;">
        <label for="jobStartYear" style="margin-bottom: 6px; font-weight: 500;">Start Year <span style="color: red;">*</span></label>
        <select id="jobStartYear" name="job_start_year" class="form-control" onchange="validateProfessionalYearRange()">
          <option value="">Select Start Year</option>
          ${yearOptions(jobStartYear)}
        </select>
      </div>
      <div class="form-group">
        <label for="jobEndYear" style="margin-bottom: 6px; font-weight: 500;">End Year <span style="color: red;">*</span></label>
        <select id="jobEndYear" name="job_end_year" class="form-control" onchange="validateProfessionalYearRange()">
          <option value="">Select End Year</option>
          ${yearOptions(jobEndYear)}
        </select>
      </div>
    </div>

    <div class="form-group">
      <input type="text" id="jobCity" name="job_city" placeholder="Job City *" value="${jobCity}">
    </div>
  `;

  // Initialize Select2 with professional styling
  setTimeout(() => {
    $('#company').select2({
      placeholder: "Search company...",
      allowClear: true,
      width: 'resolve',
      dropdownAutoWidth: true
    });

    if (company) handleCompanyChange();
  }, 0);
}




function handleCompanyChange() 
{
  
  const select = document.getElementById('company');
  const selectedCompanyName = select.value;

  const matchedCompany = dropdownData.companies.find(c => {
    return typeof c === 'string'
      ? c === selectedCompanyName
      : c.name === selectedCompanyName;
  });

  const city = typeof matchedCompany === 'string' ? '' : (matchedCompany?.city || '');
  document.getElementById('jobCity').value = city;

  // Save company ID if available
  candidateData.company_id = (typeof matchedCompany === 'object' && matchedCompany.id) ? matchedCompany.id : null;

}

function validateProfessionalYearRange() {
  const start = parseInt(document.getElementById("jobStartYear").value);
  const end = parseInt(document.getElementById("jobEndYear").value);

  if (!isNaN(start) && !isNaN(end) && start > end) {
    alert("Start Year cannot be greater than End Year.");
    document.getElementById("jobStartYear").value = "";
    document.getElementById("jobEndYear").value = "";
  }
}





function showCareerPurposeStep() {
  const section = document.getElementById('registerSection');
  const savedPurpose = candidateData.career_purpose?.replace(/_/g, ' ')?.toLowerCase() || '';

  const purposeOptions = [
    { label: "To Find a Job", icon: "fa-briefcase", color: "#fbc02d", bg: "rgba(255, 235, 59, 0.1)" },
    { label: "Compete & Upskill", icon: "fa-bolt", color: "#2196f3", bg: "rgba(33, 150, 243, 0.1)" },
    { label: "To Host an Event", icon: "fa-calendar-plus", color: "#4caf50", bg: "rgba(76, 175, 80, 0.1)" },
    { label: "To be a Mentor", icon: "fa-chalkboard-teacher", color: "#9c27b0", bg: "rgba(156, 39, 176, 0.1)" },
  ];

  const purposeHTML = purposeOptions.map(p => {
    const isSelected = p.label.toLowerCase() === savedPurpose;
    return `
      <div class="career-purpose-card ${isSelected ? 'selected' : ''}" onclick="selectPurpose(this)" style="background-color: ${p.bg};">
        <i class="fa-solid ${p.icon}" style="color: ${p.color};"></i>
        <div>${p.label}</div>
      </div>
    `;
  }).join('');

  section.innerHTML = `
    <h2><i class="fa-solid fa-arrow-left" onclick="showUserTypeStep()" style="cursor:pointer; margin-right:10px;"></i> Ready to Be Unstoppable!</h2>
    <p>Plan Your Career</p>

    <label style="font-weight: bold; display: block; margin-bottom: 14px; margin-top: 20px;">Purpose *</label>
    <div class="form-row" style="flex-wrap: wrap; gap: 14px;" id="purposeOptions" required>
      ${purposeHTML}
    </div>

    <div class="login-link" style="margin-top: 20px;">Already have an account? <a href="/login/">Login</a></div>

    <div class="bottom-bar" style="margin-top: 30px;">
      <button class="next-btn" onclick="showUserTypeStep()">
        <i class="fa-solid fa-arrow-left"></i> Back
      </button>
      <button class="next-btn" id="finishBtn">Finish</button>
    </div>
  `;

  // âœ… Finish button validation before submission
  document.getElementById('finishBtn').addEventListener('click', function (e) {
    e.preventDefault();

    const selectedCard = document.querySelector('.career-purpose-card.selected');
    if (!selectedCard) {
      alert("Please select your career purpose before continuing.");
      return;
    }

    const selectedLabel = selectedCard.innerText.trim().toLowerCase();
    candidateData.career_purpose = selectedLabel.replace(/ /g, '_');

    completeRegistration();
  });
}



  function togglePassword(icon, fieldId) {
    const input = document.getElementById(fieldId);
    if (input.type === "password") {
      input.type = "text";
      icon.classList.remove("fa-eye");
      icon.classList.add("fa-eye-slash");
    } else {
      input.type = "password";
      icon.classList.add("fa-eye");
      icon.classList.remove("fa-eye-slash");
    }
  }

function selectPurpose(el) {
  document.querySelectorAll('.career-purpose-card').forEach(card => card.classList.remove('selected'));
  el.classList.add('selected');
  candidateData.career_purpose = el.innerText.trim().toLowerCase().replace(/\s+/g, '_');
}


function getCSRFToken() {
  let cookieValue = null;
  const cookies = document.cookie.split(';');
  for (let cookie of cookies) {
    cookie = cookie.trim();
    if (cookie.startsWith('csrftoken=')) {
      cookieValue = cookie.substring('csrftoken='.length);
      break;
    }
  }
  return cookieValue;
}function completeRegistration() {
  const getVal = (selector) => document.querySelector(selector)?.value || '';
  const getText = (selector) => document.querySelector(selector)?.textContent.trim() || '';
  const getChecked = (selector) => document.querySelector(selector)?.checked || false;
  const getAttr = (selector, attr) => document.querySelector(selector)?.getAttribute(attr) || '';

  // Merge all values into formData
  const formData = { ...candidateData };


  console.log('ðŸ“¤ Sending to backend:', formData);

  fetch('/submit-candidate-form/', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'X-CSRFToken': getCSRFToken()
    },
    body: JSON.stringify(formData)
  })
  .then(res => res.json())
  .then(data => {
    if (data.status === 'success') {
      alert('Registration successful!');
      window.location.href = '/login/';
    } else {
      alert('Error: ' + data.message);
    }
  })
  .catch(error => {
    alert('Error submitting form: ' + error);
  });
}




let dropdownData = {};

fetch('/fetch-dropdown-data/')
  .then(response => response.json())
  .then(data => {
    dropdownData = data;

    console.log("Dropdown data loaded:", dropdownData);

    // âœ… Call this only after dropdownData is ready
    showCandidateForm(); // or showSchoolFields() or showCollegeFields()
  })
  .catch(error => {
    console.error('Error loading dropdown data:', error);
  });

</script>

</body>
</html>
